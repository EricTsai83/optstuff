---
title: Integration Guide
description: Step-by-step guide to integrating OptStuff image optimization into your Next.js application, including a signing utility, Server Component, and API Route examples.
---

This guide shows how to integrate OptStuff into a Next.js application. The same signing principles apply to any server-side framework.

## Security Principles

```
⚠️ Important

1. The secretKey must remain confidential
   - Store it in server-side environment variables only
   - Never expose it in frontend JavaScript
   - Never commit it to Git

2. URL signing must happen server-side
   - Server Component ✅
   - API Route ✅
   - Frontend JavaScript ❌
```

## Environment Variables

Add to your `.env` or `.env.local`:

```bash
# Server-side only — secret! Never use the NEXT_PUBLIC_ prefix
OPTSTUFF_SECRET_KEY="sk_your_secret_key_here"

# Server-side only — not secret, but no need for NEXT_PUBLIC_ prefix
# The publicKey appears in generated URLs (?key=pk_...) and is not a secret
OPTSTUFF_PUBLIC_KEY="pk_abc123..."

# Public configuration
NEXT_PUBLIC_OPTSTUFF_PROJECT_SLUG="your-project-slug"
NEXT_PUBLIC_OPTSTUFF_ENDPOINT="https://your-optstuff-deployment.com/api/v1"
```

## Create a Signing Utility

Create `lib/optstuff.ts` (server-side only):

```typescript
import crypto from "crypto";

const SECRET_KEY = process.env.OPTSTUFF_SECRET_KEY!;
const PUBLIC_KEY = process.env.OPTSTUFF_PUBLIC_KEY!;
const ENDPOINT = process.env.NEXT_PUBLIC_OPTSTUFF_ENDPOINT!;
const PROJECT_SLUG = process.env.NEXT_PUBLIC_OPTSTUFF_PROJECT_SLUG!;

/**
 * Generates a signed image optimization URL.
 *
 * @param imagePath - Source image path (e.g., "images.example.com/photo.jpg")
 * @param operations - Image operations (e.g., "w_800,f_webp")
 * @param expiresIn - Signature validity in seconds (optional)
 *
 * @example
 * signImageUrl("cdn.example.com/photo.jpg", "w_800,f_webp")
 *
 * @example
 * signImageUrl("cdn.example.com/photo.jpg", "w_800", 3600) // expires in 1 hour
 */
export function signImageUrl(
  imagePath: string,
  operations: string = "_",
  expiresIn?: number
): string {
  const path = `${operations}/${imagePath}`;

  const exp = expiresIn
    ? Math.floor(Date.now() / 1000) + expiresIn
    : undefined;

  const payload = exp ? `${path}?exp=${exp}` : path;
  const sig = crypto
    .createHmac("sha256", SECRET_KEY)
    .update(payload)
    .digest("base64url")
    .substring(0, 32);

  let url = `${ENDPOINT}/${PROJECT_SLUG}/${path}?key=${PUBLIC_KEY}&sig=${sig}`;
  if (exp) url += `&exp=${exp}`;

  return url;
}
```

## Usage in Next.js

### Option 1: Server Component (Recommended)

```tsx
import { signImageUrl } from "@/lib/optstuff";

export default function HomePage() {
  const heroImage = signImageUrl(
    "cdn.example.com/hero.jpg",
    "w_1200,f_webp",
    86400 // 24 hours
  );

  return (
    <main>
      <img src={heroImage} alt="Hero" width={1200} height={600} />
    </main>
  );
}
```

### Option 2: API Route + Client Component

Create an API route:

```typescript
// app/api/image-url/route.ts
import { signImageUrl } from "@/lib/optstuff";
import { NextRequest, NextResponse } from "next/server";

export async function GET(request: NextRequest) {
  const searchParams = request.nextUrl.searchParams;
  const src = searchParams.get("src");
  const width = searchParams.get("w");
  const height = searchParams.get("h");
  const format = searchParams.get("f") || "webp";

  if (!src) {
    return NextResponse.json(
      { error: "Missing src parameter" },
      { status: 400 }
    );
  }

  const ops = [
    width && `w_${width}`,
    height && `h_${height}`,
    `f_${format}`,
  ].filter(Boolean).join(",");

  const signedUrl = signImageUrl(src, ops, 3600);

  return NextResponse.json({ url: signedUrl });
}
```

Call it from a client component:

```tsx
"use client";

import { useState, useEffect } from "react";

type OptimizedImageProps = {
  readonly src: string;
  readonly width?: number;
  readonly alt: string;
};

export function OptimizedImage({ src, width, alt }: OptimizedImageProps) {
  const [imageUrl, setImageUrl] = useState<string>("");

  useEffect(() => {
    const fetchUrl = async () => {
      const params = new URLSearchParams({ src });
      if (width) params.set("w", width.toString());

      const res = await fetch(`/api/image-url?${params}`);
      const { url } = await res.json();
      setImageUrl(url);
    };

    fetchUrl();
  }, [src, width]);

  if (!imageUrl) return <div>Loading...</div>;

  return <img src={imageUrl} alt={alt} width={width} />;
}
```

## Operations Reference

| Operation | Description | Example |
|-----------|-------------|---------|
| `w_{n}` | Width | `w_800` → 800px wide |
| `h_{n}` | Height | `h_600` → 600px tall |
| `s_{w}x{h}` | Size | `s_800x600` → 800×600 |
| `q_{n}` | Quality (1-100) | `q_80` → 80% quality |
| `f_{format}` | Format | `f_webp`, `f_avif`, `f_png`, `f_jpg` |
| `fit_{mode}` | Fit mode | `fit_cover`, `fit_contain`, `fit_fill` |
| `embed` | Embed mode | `embed` |
| `_` | No operations | Forwards the original image |

For the full operations reference (including fit modes and combination examples), see [Image Operations](/docs/api-reference/image-operations).

## Pre-Launch Checklist

Before going to production, verify:

- [ ] `secretKey` (`sk_...`) is in an environment variable **without** `NEXT_PUBLIC_` prefix
- [ ] `publicKey` (`pk_...`) is also in an environment variable for easy management
- [ ] `.env` file is in `.gitignore`
- [ ] Signing logic runs only in Server Components or API Routes
- [ ] No frontend code references the `secretKey`
- [ ] Appropriate `exp` expiration is set for signed URLs
- [ ] Domain whitelists are configured in the dashboard

## Troubleshooting

| Error | Likely Cause | Solution |
|-------|-------------|----------|
| `403` Invalid signature | Wrong key, wrong path order, or wrong encoding | See [Troubleshooting Signature Errors](/docs/api-reference/error-codes#troubleshooting-signature-errors) |
| `403` Source domain not allowed | Image origin not in key's allowed domains | Add the domain in Dashboard → API Key settings |
| `403` Invalid referer | Your website not in project's allowed domains | Add the domain in Dashboard → Project settings |

For the complete error reference, see [Error Codes](/docs/api-reference/error-codes).

## Using with `next/image`

You can use OptStuff as a custom loader for `next/image`. See the [CDN and Caching guide](/docs/guides/cdn-caching#using-with-nextimage) for a ready-to-use `optstuffLoader` implementation.

## Further Reading

- [URL Signing](/docs/guides/url-signing) — Signature formula and security properties
- [Domain Whitelisting](/docs/guides/domain-whitelisting) — Configure allowed domains
- [CDN and Caching](/docs/guides/cdn-caching) — CDN integration and `next/image` loader
- [Security Best Practices](/docs/guides/security-best-practices) — Recommendations for production
