---
title: System Overview
description: Comprehensive technical overview of the OptStuff image optimization service — architecture, security model, core components, and request lifecycle.
---

This document provides a comprehensive technical overview of the OptStuff image optimization service, covering its architecture, security model, and core components.

## Introduction

OptStuff is an enterprise-grade image optimization API service that enables developers and teams to deliver optimized images at scale. The system provides on-the-fly image transformation with fine-grained access control, robust security mechanisms, and multi-tenant support.

### Core Value Proposition

- **On-Demand Optimization**: Transform images dynamically via URL parameters
- **Enterprise Security**: Multi-layer authentication and encryption
- **Multi-Tenant Architecture**: Teams, projects, and API keys hierarchy
- **Usage Analytics**: Real-time monitoring and bandwidth tracking
- **CDN-Friendly**: Aggressive caching headers for edge deployment

## System Architecture

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                   │
│                                                                             │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                      │
│  │   Team A    │    │   Team B    │    │   Team C    │                      │
│  │  (Owner)    │    │  (Owner)    │    │  (Owner)    │                      │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                      │
│         │                  │                  │                             │
│  ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐                      │
│  │  Project 1  │    │  Project 3  │    │  Project 5  │                      │
│  │  Project 2  │    │  Project 4  │    │             │                      │
│  └──────┬──────┘    └─────────────┘    └─────────────┘                      │
│         │                                                                   │
│  ┌──────┴──────┐                                                            │
│  │  API Keys   │                                                            │
│  └─────────────┘                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API GATEWAY                                      │
│                                                                             │
│  Endpoint: /api/v1/{projectSlug}/{operations}/{imageUrl}                    │
│  Query Params: ?key={publicKey}&sig={signature}&exp={expiration}            │
│                                                                             │
│  Validation Pipeline:                                                       │
│  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐  ┌───────┐           │
│  │API Key│→ │Project│→ │ Sig   │→ │ Rate  │→ │Referer│→ │Source │           │
│  │Valid  │  │Exists │  │Verify │  │Limit  │  │Domain │  │Domain │           │
│  └───────┘  └───────┘  └───────┘  └───────┘  └───────┘  └───────┘           │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        IMAGE PROCESSING ENGINE                              │
│                                                                             │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐          │
│  │  IPX (Sharp)    │    │  Format Conv.   │    │  Cache Layer    │          │
│  │  - Resize       │    │  - WebP         │    │  - CDN Headers  │          │
│  │  - Crop         │    │  - AVIF         │    │  - ETag         │          │
│  │  - Quality      │    │  - PNG/JPEG     │    │  - Cache-Control│          │
│  └─────────────────┘    └─────────────────┘    └─────────────────┘          │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Core Components

### 1. Multi-Tenant Resource Hierarchy

The system implements a three-level hierarchy for resource organization:

| Level | Entity | Description |
|-------|--------|-------------|
| 1 | **Team** | Top-level organization unit (personal or shared workspace) |
| 2 | **Project** | Isolated environment within a team for different applications |
| 3 | **API Key** | Granular access credential bound to a specific project |

### 2. Authentication System

User authentication is handled by **Clerk**, providing:

- Social login (Google, GitHub, etc.)
- Email/password authentication
- Session management
- User identity verification

### 3. API Key Management

Each API key consists of a dual-key system:

| Key Type | Format | Purpose | Visibility |
|----------|--------|---------|------------|
| Public Key | `pk_<22 base64url chars>` | Request identification and URL lookup | Safe to expose in URLs, stored in plaintext |
| Secret Key | `sk_<43 base64url chars>` | URL signature generation | **Must be kept secret**, stored encrypted |

### 4. Image Processing Engine

Built on **IPX** (powered by **Sharp**), the engine supports:

| Operation | Parameter | Example |
|-----------|-----------|---------|
| Width | `w_` | `w_800` |
| Height | `h_` | `h_600` |
| Quality | `q_` | `q_80` |
| Format | `f_` | `f_webp`, `f_avif` |
| Fit | `fit_` | `fit_cover`, `fit_contain` |
| Scale | `s_` | `s_0.5` |

### 5. Usage Analytics

Real-time tracking and monitoring includes:

- Request counts (per minute, daily, monthly)
- Bandwidth consumption
- Per-API-key usage breakdown
- Recent request logs
- Top requested images
- Bandwidth savings metrics

## Security Architecture

### Three-Tier Key Hierarchy

```text
Level 0: System Key (Environment Variable)
┌─────────────────────────────────────────────────────────────────────────────┐
│  API_KEY_ENCRYPTION_SECRET                                                  │
│  Purpose: Encrypt/decrypt all sensitive data in database                    │
│  Scope: System-wide singleton                                               │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │ Protects
                                ▼
Level 1: API Key Secrets (Per API Key)
┌─────────────────────────────────────────────────────────────────────────────┐
│  publicKey (pk_xxx)        │ secretKey (sk_xxx)                             │
│  Purpose: Identify API Key │ Purpose: Generate/verify URL signatures        │
│  Exposure: Can be known    │ Exposure: Must remain confidential              │
└────────────────────────────┴────────────────────────────────────────────────┘
                                │ Used for
                                ▼
Level 2: Request Signatures (Per Request)
┌─────────────────────────────────────────────────────────────────────────────┐
│  signature (sig)                                                            │
│  Purpose: Prove possession of secretKey                                     │
│  Property: One-way hash, cannot reverse to secretKey                        │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Encryption Mechanisms

| Mechanism | Algorithm | Purpose |
|-----------|-----------|---------|
| Key Derivation | HKDF (RFC 5869) with SHA-256 | Derive encryption key from master secret |
| Data Encryption | AES-256-GCM | Encrypt secret keys at rest |
| URL Signing | HMAC-SHA256 | Sign image request URLs |
| Signature Comparison | `timingSafeEqual` | Prevent timing attacks |

### Four-Layer Permission Model

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│ Level 1: User Layer (Clerk Authentication)                                  │
│ → User login and identity verification                                      │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Level 2: Team Layer                                                         │
│ → Resource ownership: team.ownerId === userId                               │
│ → Permissions: Create/delete projects, manage API keys, view stats          │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Level 3: Project Layer                                                      │
│ → allowedRefererDomains: Control which websites can use the service         │
│ → Validation: HTTP Referer header check                                     │
└─────────────────────────────┬───────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│ Level 4: API Key Layer                                                      │
│ → allowedSourceDomains: Restrict image sources                              │
│ → Rate limits: rateLimitPerMinute, rateLimitPerDay                         │
│ → Expiration: expiresAt                                                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### Domain Whitelist Architecture

| Layer | Setting | Question Answered | Validation Method |
|-------|---------|-------------------|-------------------|
| Project | `allowedRefererDomains` | Who can **use** this service? | HTTP Referer header |
| API Key | `allowedSourceDomains` | Which **image sources** can be processed? | Image URL in request |

## Request Flow

### Image Request Lifecycle

```text
1. Client Preparation
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ path = "w_800,f_webp/images.example.com/photo.jpg"                      │
   │ sig = HMAC-SHA256(secretKey, path)                                      │
   │ url = /api/v1/{slug}/{path}?key={publicKey}&sig={sig}&exp={exp}           │
   └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
2. Server Validation
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ a. Parse URL parameters (publicKey, signature)                            │
   │ b. Lookup API Key by publicKey                                            │
   │ c. Validate project exists and slug matches                             │
   │ d. Verify signature: HMAC-SHA256(secretKey, path) === signature         │
   │ e. Check rate limits (only authenticated requests consume quota)        │
   │ f. Validate referer domain, source domain                               │
   └─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
3. Image Processing
   ┌─────────────────────────────────────────────────────────────────────────┐
   │ a. Fetch source image                                                   │
   │ b. Apply transformations (resize, format, quality)                      │
   │ c. Set cache headers                                                    │
   │ d. Return optimized image                                               │
   └─────────────────────────────────────────────────────────────────────────┘
```

### API Key Lifecycle

| Phase | Actions |
|-------|---------|
| **Creation** | Generate key pair → Encrypt → Store in DB → Return to user (once) |
| **Usage** | Sign URLs with secretKey → Server validates signature |
| **Rotation** | Revoke old key + Create new key atomically (DB transaction, inherits settings) → Clear cache → Update application |
| **Revocation** | Mark as revoked → Clear cache → Reject future requests |

## Rate Limiting

| Limit Type | Range | Default | Description |
|------------|-------|---------|-------------|
| Per-minute | 1–10,000 | 60 | Rolling window rate limit |
| Per-day | 1–1,000,000 | 10,000 | Calendar day limit |

## Technical Specifications

| Specification | Details |
|---------------|---------|
| Encryption | AES-256-GCM with HKDF key derivation |
| Signing | HMAC-SHA256 (32-character output) |
| Image Engine | IPX (powered by Sharp) |
| Supported Input Formats | JPEG, PNG, WebP, AVIF, GIF |
| Supported Output Formats | JPEG, PNG, WebP, AVIF |
| Authentication Provider | Clerk |
| Database | PostgreSQL (via Drizzle ORM) |
| Framework | Next.js (App Router) |

## Attack Protections

| Attack Type | Protection Mechanism |
|-------------|---------------------|
| Brute force | HMAC-SHA256 + 32-char output makes collision computationally infeasible |
| Replay attacks | `exp` expiration parameter limits signature validity |
| Timing attacks | `timingSafeEqual` constant-time comparison |
| Data theft | AES-256-GCM encrypted storage protects database leaks |
| Man-in-the-middle | HTTPS + signature validation provides dual protection |
| Hotlinking | Referer domain whitelist prevents unauthorized embedding |
| Unauthorized sources | Source domain whitelist restricts image origins |

## Error Handling

For the complete error code list with causes and solutions, see [Error Codes](/api-reference/error-codes).

## Related Documentation

| Document | Description |
|----------|-------------|
| [What is OptStuff?](/introduction/what-is-optstuff) | Product-focused service description |
| [Domain Whitelisting](/guides/domain-whitelisting) | Domain whitelist configuration |
| [Integration Guide](/getting-started/integration-guide) | Step-by-step integration tutorial |
| [URL Signing](/guides/url-signing) | Request signing and validation |
| [Security Best Practices](/guides/security-best-practices) | Security recommendations |
