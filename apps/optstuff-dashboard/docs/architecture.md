# 系統架構

本文件說明 OptStuff 圖片優化服務的整體架構與密鑰層級。

## 系統架構概述

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              用戶層                                      │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                  │
│  │   Team A    │    │   Team B    │    │   Team C    │                  │
│  │  (Owner)    │    │  (Owner)    │    │  (Owner)    │                  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘                  │
│         │                  │                  │                          │
│  ┌──────┴──────┐    ┌──────┴──────┐    ┌──────┴──────┐                  │
│  │  Project 1  │    │  Project 3  │    │  Project 5  │                  │
│  │  Project 2  │    │  Project 4  │    │             │                  │
│  └──────┬──────┘    └─────────────┘    └─────────────┘                  │
│         │                                                                │
│  ┌──────┴──────┐                                                        │
│  │  API Key 1  │                                                        │
│  │  API Key 2  │                                                        │
│  │  API Key 3  │                                                        │
│  └─────────────┘                                                        │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           API Gateway                                    │
│                                                                          │
│  /api/v1/{projectSlug}/{operations}/{imageUrl}?key=...&sig=...&exp=... │
│                                                                          │
│  驗證層:                                                                 │
│  1. Project 存在性驗證                                                   │
│  2. API Key 有效性驗證                                                   │
│  3. 簽名驗證 (HMAC-SHA256)                                              │
│  4. Referer 域名驗證 (Project 級)                                        │
│  5. Source 域名驗證 (API Key 級)                                         │
│  6. 過期時間驗證                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                          圖片處理引擎 (IPX)                              │
└─────────────────────────────────────────────────────────────────────────┘
```

## 密鑰層級與用途

系統使用三層密鑰架構：

### 系統級密鑰

| 密鑰 | 儲存位置 | 用途 |
|------|---------|------|
| `API_KEY_ENCRYPTION_SECRET` | 環境變數 | 加密/解密資料庫中的敏感資料 |

```
環境變數: API_KEY_ENCRYPTION_SECRET="your-32-char-secret-key"
                        │
                        ▼
              ┌─────────────────────────────────────────┐
              │   HKDF (RFC 5869)                       │
              │   Algorithm: SHA-256                    │
              │   Salt: "optstuff-api-key-v1"           │
              │   Info: "api-key-encryption"            │
              │   產生 256-bit 加密密鑰                  │
              └─────────────────────────────────────────┘
                        │
                        ▼
              ┌─────────────────────┐
              │   AES-256-GCM       │
              │   加密/解密資料      │
              └─────────────────────┘
```

### API Key 級密鑰

每個 API Key 包含兩個密鑰：

| 密鑰 | 格式 | 用途 | 儲存方式 |
|------|------|------|---------|
| `keyFull` | `pk_<64 hex chars>` | API Key 識別 | 加密後存 DB |
| `secretKey` | `sk_<64 hex chars>` | URL 簽名 | 加密後存 DB |
| `keyPrefix` | `pk_<8 chars>` | 快速查詢、顯示識別 | 明文存 DB |

### 密鑰關係圖

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    密鑰層級結構                                          │
└─────────────────────────────────────────────────────────────────────────┘

Level 0: 系統密鑰 (環境變數)
┌─────────────────────────────────────────────────────────────────────────┐
│  API_KEY_ENCRYPTION_SECRET                                              │
│  用途: 保護所有存在資料庫中的敏感資料                                    │
│  範圍: 整個系統唯一                                                      │
└───────────────────────────────┬─────────────────────────────────────────┘
                                │ 加密保護
                                ▼
Level 1: API Key 密鑰 (每個 API Key 一組)
┌─────────────────────────────────────────────────────────────────────────┐
│  keyFull (pk_xxx)          │ secretKey (sk_xxx)                        │
│  用途: 識別 API Key         │ 用途: 產生/驗證 URL 簽名                  │
│  公開: 可被知道             │ 公開: 必須保密                            │
└─────────────────────────────┴───────────────────────────────────────────┘
                                │ 用於簽名
                                ▼
Level 2: 請求簽名 (每個請求一個)
┌─────────────────────────────────────────────────────────────────────────┐
│  signature (sig)                                                        │
│  用途: 證明請求者擁有 secretKey                                          │
│  特性: 單向雜湊，無法反推 secretKey                                      │
└─────────────────────────────────────────────────────────────────────────┘
```

## 延伸閱讀

- [API Key 生命週期](./api-key-lifecycle.md) - 了解 API Key 的建立與管理
- [資料加密機制](./encryption.md) - 深入了解 HKDF 與 AES-256-GCM
- [設計決策說明](./design-decisions.md) - 為什麼這樣設計
